
output_dir = "simresults"
replicates = [1, 2]
itsearch_map = [0, 1]
blip_times = [5]

singularity:
        "docker://onceltuca/graphical_model_benchmark:mytag"

rule sample_dag:
    output:
        "{output_dir}/dag_{replicate}.rds"
    shell:
        "Rscript scripts/sample_dags.R --filename {output} --nodes 20 --parents 2 --seed {wildcards.replicate}"

rule sample_bn:
    input:
        "{output_dir}/dag_{replicate}.rds"
    output:
        bn="{output_dir}/bn_{replicate}.rds"
    shell:
        "Rscript scripts/sample_bayesian_network_for_dag.R "
        "--filename_dag {input} "
        "--filename {output} --seed {wildcards.replicate} "

rule sample_data:
    input:
        "{output_dir}/bn_{replicate}.rds"
    output:
        "{output_dir}/data_{replicate}.csv"
    shell:
        "Rscript scripts/sample_data.R --filename {output} --filename_bn {input} --samples 100 --seed {wildcards.replicate}"

rule sim_blip:
    input: 
        dag="simresults/dag_{replicate}.rds",
        data="simresults/data_{replicate}.csv"
    output: 
        "simresults/ROC_blip_time_{blip_time}_{replicate}.csv"
    message: 
        "Executing blip algorithm on the following files: {input}."
    shell: 
        "Rscript scripts/run_blip.R --filename_data {input.data} "
        "--filename_dag {input.dag} "
        "--output_dir {output_dir} "
        "--replicate {wildcards.replicate} "
        "--max_time {wildcards.blip_time}" 

rule itsearch:
    input: 
        # Maybe we should set title here?
        dag="simresults/dag_{replicate}.rds",
        data="simresults/data_{replicate}.csv"
    output: 
        "simresults/ROC_itsearch_map_{map}_{replicate}.csv",
        "simresults/endspace_itsearch_map_{map}_{replicate}.rds"
    message: 
        "Executing iterative search algorithm on the following files: {input}."
    shell: 
        "Rscript scripts/run_iterative_search.R "
        "--filename_data {input.data} "
        "--filename_dag {input.dag} "
        "--output_dir {output_dir} "
        "--replicate {wildcards.replicate} "
        "--seed {wildcards.replicate} "
        "--map {wildcards.map}"
        # Maybe we should set title here? But it is so dependent on the parameters.
        # each combo should have a.

rule ordermcmc_itsearch:
    input: 
        dag="simresults/dag_{replicate}.rds",
        data="simresults/data_{replicate}.csv",
        startspace="simresults/endspace_itsearch_map_{map}_{replicate}.rds"
        # Fixa ordermcmc, ska kunna köras med olika startspacce, inte bara från itsearch.
        # kanske bara att lägga till filnamened på startspace

    output: 
        "simresults/ROC_orderMCMC_{replicate}_startspace_endspace_itsearch_map_{map}_{replicate}.csv",
    message: 
        "Executing iterative search algorithm on the following files: {input}."
    shell: 
        "Rscript scripts/run_order_mcmc.R "
        "--filename_data {input.data} "
        "--filename_dag {input.dag} "
        "--filename_startspace {input.startspace} "
        "--output_dir {output_dir} "
        "--replicate {wildcards.replicate} "
        "--seed {wildcards.replicate} "

# How to label the runs of interest?
# It seems weird that the input is the results filenames.
# Since this means that the labels must be in the filenames.
rule plot:
    input: 
        expand(output_dir+"/ROC_blip_time_{blip_time}_{replicate}.csv", replicate=replicates, blip_time=blip_times),
        expand(output_dir+"/ROC_itsearch_map_{map}_{replicate}.csv", replicate=replicates, map=itsearch_map),
        expand(output_dir+"/ROC_orderMCMC_{replicate}_startspace_endspace_itsearch_map_{map}_{replicate}.csv", 
              replicate=replicates, 
              map=itsearch_map)
    output:
        "{output_dir}/ROC.eps"
    shell: 
        "Rscript scripts/plot_results.R --directory simresults --roc_files {input}"
