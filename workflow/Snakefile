import json
from jsonschema import validate
import snakemake.utils
import sys, getopt
import shutil
import filecmp

from dirsync import sync
from pathlib import Path
import os

args = sys.argv

configfilename="config/config.json"

i=0
for arg in args:
    if arg=="--configfile" or arg=="--configfiles": # This is strange
        configfilename = args[i+1]
        break
    i+=1

configfile: 
    configfilename

snakemake.utils.validate(config, 'schemas/config.schema.json')

include: "rules/docker_images.smk"

singularity:
    docker_image("benchmark")


def get_active_rules(wildcards):
    rules = []
    for key, val in config["benchmark_setup"]["evaluation"].items():
        # Check if boolean or list. 
        if isinstance(val, bool) and val is True:
            rules.append("results/output/"+key+"/"+key+".done")
        if isinstance(val, list) and val != []:
            rules.append("results/output/"+key+"/"+key+".done")
    return rules

rule all:
    input: get_active_rules

include: "rules/validate.smk"
include: "rules/pattern_strings.smk"
include: "rules/algorithm_strings.smk"
include: "rules/helper_functions.smk"
include: "rules/algorithm_shell_commands.smk"
include: "rules/algorithm_summary_shell_command.smk"
include: "rules/sample_adjmat.smk"
include: "rules/sample_parameters.smk"
include: "rules/sample_data.smk"
include: "rules/algorithm_rules.smk"
include: "rules/evaluation.smk"

rule heatmap_from_adjvec_trajectory:
    input:
        "workflow/scripts/graphtraj_est.py",
        traj = "{output_dir}/adjvecs/{something}/seed={seed}/adjvecs.csv"
    output:
        heatmap = "{output_dir}/heatmap_estimate/{something}/burnin={burnin}/seed={seed}/heatmap.csv" 
    params:
        estimator="heatmap",
        burnin="{burnin}",
        graph_type="dag"
    singularity:
        docker_image("networkx")
    script: 
        "scripts/graphtraj_est.py"    

rule adjmat_from_heatmap:
    input:
        heatmap="{output_dir}/heatmap_estimate/"\ 
                "{something}/"\
                "burnin={burnin}/"\
                "{somethingelse}/" \
                "heatmap.csv"
    output:
        adjmat_est="{output_dir}/adjmat_estimate/"\
                    "{something}/" + pattern_strings["mcmc_est"] + "/{somethingelse}/"\
                    "adjmat.csv"
    shell:
        "Rscript workflow/scripts/run_threshold_heatmap.R " \
        "--heatmap {input.heatmap} " \
        "--filename {output.adjmat_est} " \
        "--threshold {wildcards.threshold}"
